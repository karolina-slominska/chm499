import pandas as pd
import tkinter as tk
from tkinter import filedialog
import os


root = tk.Tk()
root.withdraw()

print("Select PPDB file (base database)")
ppdb_path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx *.xls")])

print("Select BPDB file (to merge)")
bpdb_path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx *.xls")])

if not ppdb_path or not bpdb_path:
    print(" Missing file selection.")
    exit()


ppdb = pd.read_excel(ppdb_path)
bpdb = pd.read_excel(bpdb_path)


ppdb.columns = ppdb.columns.str.strip()
bpdb.columns = bpdb.columns.str.strip()


def norm(val):
    if pd.isna(val):
        return ""
    return str(val).strip().lower()

ppdb_pairs = set(
    (norm(name), norm(cas)) for name, cas in zip(ppdb.get("Name", []), ppdb.get("CAS RN", []))
)


new_rows = []
overlap_count = 0

for _, row in bpdb.iterrows():
    name = norm(row.get("Name", ""))
    cas = norm(row.get("CAS RN", ""))
    if (name, cas) in ppdb_pairs:  
        overlap_count += 1
    else:
        new_rows.append(row)

bpdb_new = pd.DataFrame(new_rows)


merged = pd.concat([ppdb, bpdb_new], ignore_index=True)


base, _ = os.path.splitext(ppdb_path)
out_file = base + "_merged_with_bpdb.xlsx"
merged.to_excel(out_file, index=False, engine="openpyxl")

print(f"Merged database saved to {out_file}")
print(f"Final size: {len(merged)} rows")
print(f"   - PPDB: {len(ppdb)}")
print(f"   - Added from BPDB: {len(new_rows)}")
print(f"   - Overlap (exact Name + CAS match): {overlap_count}")
